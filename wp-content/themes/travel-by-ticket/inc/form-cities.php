<?php 
add_action('rest_api_init', function () {
    register_rest_route('busticket/v1', '/cities/(?P<lang>[a-zA-Z]+)', array(
        'methods' => 'GET',
        'callback' => 'get_cities_cached',
        'permission_callback' => '__return_true'
    ));
});

function get_cities_cached($request) {
    $lang = $request['lang'];
    $search = $request->get_param('search');
    
    $cache_key = 'bus_cities_' . $lang . '_v3';
    $cache_duration = 24 * HOUR_IN_SECONDS;
    
    // Proveri cache
    $cached = get_transient($cache_key);
    
    if ($cached === false) {
        error_log('BusTicket: Cache MISS for lang: ' . $lang);
        
        // Pozovi eksterni API
        $response = wp_remote_post('https://busticket4.me/bus/web_servisi/servisi/rest_bus_search.php?name=doCitiesSearch', array(
            'body' => array('jezik' => $lang),
            'timeout' => 30
        ));
        
        if (is_wp_error($response)) {
            error_log('BusTicket API Error: ' . $response->get_error_message());
            return new WP_Error('api_error', 'Failed to fetch cities', array('status' => 500));
        }
        
        $body = wp_remote_retrieve_body($response);
        $cached = json_decode($body, true);
        
        if (json_last_error() !== JSON_ERROR_NONE) {
            error_log('BusTicket JSON Error: ' . json_last_error_msg());
            return new WP_Error('json_error', 'Invalid JSON', array('status' => 500));
        }
        
        if (empty($cached) || !is_array($cached)) {
            error_log('BusTicket: Empty or invalid data received');
            return new WP_Error('no_data', 'No cities available', array('status' => 404));
        }
        
        error_log('BusTicket: Caching ' . count($cached) . ' cities');
        set_transient($cache_key, $cached, $cache_duration);
    } else {
        error_log('BusTicket: Cache HIT - ' . count($cached) . ' cities');
    }
    
    // Filter search
    $filtered = $cached;
    if ($search) {
        $filtered = array_filter($cached, function($city) use ($search) {
            $searchIn = strtolower($city['city_label'] ?? $city['city_primary_name'] ?? '');
            return stripos($searchIn, strtolower($search)) !== false;
        });
        $filtered = array_values($filtered); // Re-index
    }
    
    // UKLONJENA PAGINATION - vrati SVE gradove
    return rest_ensure_response($filtered);
}


function bus_search_form_shortcode() {
    ob_start();
    ?>
    <div class="bus-search-form">
        <form method="GET" action="<?php echo esc_url(home_url('/bus-results')); ?>" class="bus-form">
            <div class="form-row">
                
                <!-- DESTINATIONS -->
                <div class="destinations">
                    <div class="form-field">
                        <label for="from-city"><?php echo __( 'From', 'travel')?></label>
                        <div class="depart">
                            <svg width="12" height="16" viewBox="0 0 12 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M6.19507 7.78431C6.55177 7.78431 6.85619 7.6573 7.10833 7.4033C7.3606 7.14929 7.48673 6.84394 7.48673 6.48723C7.48673 6.13053 7.35966 5.82604 7.10552 5.57377C6.85152 5.32163 6.54616 5.19557 6.18946 5.19557C5.83275 5.19557 5.52833 5.32257 5.2762 5.57658C5.02393 5.83058 4.89779 6.13594 4.89779 6.49264C4.89779 6.84934 5.02486 7.15383 5.279 7.4061C5.53301 7.65824 5.83836 7.78431 6.19507 7.78431ZM6.19226 14.1515C7.69827 12.8406 8.88891 11.5074 9.76418 10.1519C10.6394 8.79639 11.0771 7.62405 11.0771 6.63487C11.0771 5.16892 10.613 3.95899 9.68485 3.00506C8.7567 2.05127 7.5925 1.57437 6.19226 1.57437C4.79202 1.57437 3.62783 2.05127 2.69967 3.00506C1.77152 3.95899 1.30745 5.16892 1.30745 6.63487C1.30745 7.62405 1.74508 8.79639 2.62035 10.1519C3.49561 11.5074 4.68625 12.8406 6.19226 14.1515ZM6.19226 15.227C4.30925 13.5618 2.89085 12.0088 1.93705 10.568C0.983128 9.12726 0.506165 7.81622 0.506165 6.63487C0.506165 4.93975 1.05811 3.54159 2.16201 2.44036C3.26578 1.33913 4.6092 0.788513 6.19226 0.788513C7.77533 0.788513 9.11874 1.33913 10.2225 2.44036C11.3264 3.54159 11.8784 4.93975 11.8784 6.63487C11.8784 7.81622 11.4014 9.12726 10.4475 10.568C9.49368 12.0088 8.07528 13.5618 6.19226 15.227Z" fill="#511371"/>
                            </svg>
                            <select class="select__city" id="from-city" name="from_city" required disabled>
                            </select>
                        </div>
                    </div>
                
                    <div class="form-field">
                        <label for="to-city"><?php echo __( 'To', 'travel')?></label>
                        <div class="final">
                            <svg width="12" height="16" viewBox="0 0 12 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M6.19507 7.78431C6.55177 7.78431 6.85619 7.6573 7.10833 7.4033C7.3606 7.14929 7.48673 6.84394 7.48673 6.48723C7.48673 6.13053 7.35966 5.82604 7.10552 5.57377C6.85152 5.32163 6.54616 5.19557 6.18946 5.19557C5.83275 5.19557 5.52833 5.32257 5.2762 5.57658C5.02393 5.83058 4.89779 6.13594 4.89779 6.49264C4.89779 6.84934 5.02486 7.15383 5.279 7.4061C5.53301 7.65824 5.83836 7.78431 6.19507 7.78431ZM6.19226 14.1515C7.69827 12.8406 8.88891 11.5074 9.76418 10.1519C10.6394 8.79639 11.0771 7.62405 11.0771 6.63487C11.0771 5.16892 10.613 3.95899 9.68485 3.00506C8.7567 2.05127 7.5925 1.57437 6.19226 1.57437C4.79202 1.57437 3.62783 2.05127 2.69967 3.00506C1.77152 3.95899 1.30745 5.16892 1.30745 6.63487C1.30745 7.62405 1.74508 8.79639 2.62035 10.1519C3.49561 11.5074 4.68625 12.8406 6.19226 14.1515ZM6.19226 15.227C4.30925 13.5618 2.89085 12.0088 1.93705 10.568C0.983128 9.12726 0.506165 7.81622 0.506165 6.63487C0.506165 4.93975 1.05811 3.54159 2.16201 2.44036C3.26578 1.33913 4.6092 0.788513 6.19226 0.788513C7.77533 0.788513 9.11874 1.33913 10.2225 2.44036C11.3264 3.54159 11.8784 4.93975 11.8784 6.63487C11.8784 7.81622 11.4014 9.12726 10.4475 10.568C9.49368 12.0088 8.07528 13.5618 6.19226 15.227Z" fill="#511371"/>
                            </svg>
                            <select id="to-city" name="to_city" required disabled>
                            </select>
                        </div>
                    </div>
                </div>
                <!-- END DESTINATIONS -->

                <!-- DATES -->
                <div class="dates">
                    <div class="form-field">
                        <label for="depart-date"><?php echo __( 'Departing on', 'travel')?></label>
                        <div class="dep-date">
                            <svg width="14" height="16" viewBox="0 0 14 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3.66666 9.57045C3.49472 9.57045 3.34486 9.50663 3.21708 9.37899C3.08944 9.25135 3.02562 9.10156 3.02562 8.92961C3.02562 8.75753 3.08944 8.60767 3.21708 8.48003C3.34486 8.35239 3.49472 8.28857 3.66666 8.28857C3.83861 8.28857 3.98847 8.35239 4.11624 8.48003C4.24388 8.60767 4.3077 8.75753 4.3077 8.92961C4.3077 9.10156 4.24388 9.25135 4.11624 9.37899C3.98847 9.50663 3.83861 9.57045 3.66666 9.57045ZM6.99999 9.57045C6.82805 9.57045 6.67819 9.50663 6.55041 9.37899C6.42277 9.25135 6.35895 9.10156 6.35895 8.92961C6.35895 8.75753 6.42277 8.60767 6.55041 8.48003C6.67819 8.35239 6.82805 8.28857 6.99999 8.28857C7.17194 8.28857 7.3218 8.35239 7.44958 8.48003C7.57722 8.60767 7.64104 8.75753 7.64104 8.92961C7.64104 9.10156 7.57722 9.25135 7.44958 9.37899C7.3218 9.50663 7.17194 9.57045 6.99999 9.57045ZM10.3333 9.57045C10.1614 9.57045 10.0115 9.50663 9.88374 9.37899C9.75611 9.25135 9.69229 9.10156 9.69229 8.92961C9.69229 8.75753 9.75611 8.60767 9.88374 8.48003C10.0115 8.35239 10.1614 8.28857 10.3333 8.28857C10.5053 8.28857 10.6551 8.35239 10.7829 8.48003C10.9106 8.60767 10.9744 8.75753 10.9744 8.92961C10.9744 9.10156 10.9106 9.25135 10.7829 9.37899C10.6551 9.50663 10.5053 9.57045 10.3333 9.57045ZM1.67958 15.5C1.29597 15.5 0.975689 15.3716 0.718745 15.1146C0.4618 14.8577 0.333328 14.5374 0.333328 14.1538V3.51295C0.333328 3.12934 0.4618 2.80906 0.718745 2.55211C0.975689 2.29517 1.29597 2.1667 1.67958 2.1667H3.15374V0.307739H4.05124V2.1667H10.0129V0.307739H10.8462V2.1667H12.3204C12.704 2.1667 13.0243 2.29517 13.2812 2.55211C13.5382 2.80906 13.6667 3.12934 13.6667 3.51295V14.1538C13.6667 14.5374 13.5382 14.8577 13.2812 15.1146C13.0243 15.3716 12.704 15.5 12.3204 15.5H1.67958ZM1.67958 14.6667H12.3204C12.4487 14.6667 12.5663 14.6133 12.6731 14.5065C12.7799 14.3997 12.8333 14.2821 12.8333 14.1538V6.84628H1.16666V14.1538C1.16666 14.2821 1.22006 14.3997 1.32687 14.5065C1.43368 14.6133 1.55124 14.6667 1.67958 14.6667ZM1.16666 6.01274H12.8333V3.51295C12.8333 3.38461 12.7799 3.26704 12.6731 3.16024C12.5663 3.05343 12.4487 3.00003 12.3204 3.00003H1.67958C1.55124 3.00003 1.43368 3.05343 1.32687 3.16024C1.22006 3.26704 1.16666 3.38461 1.16666 3.51295V6.01274Z" fill="#511371"/>
                            </svg>
                            <input type="text" id="depart-date" name="depart_date" placeholder="Choose date" required readonly>
                        </div>
                    </div>
                    <div class="form-field">
                        <label for="return-date"><?php echo __( 'Return on', 'travel')?></label>
                        <div class="dep-date">
                            <svg width="14" height="16" viewBox="0 0 14 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3.66666 9.57045C3.49472 9.57045 3.34486 9.50663 3.21708 9.37899C3.08944 9.25135 3.02562 9.10156 3.02562 8.92961C3.02562 8.75753 3.08944 8.60767 3.21708 8.48003C3.34486 8.35239 3.49472 8.28857 3.66666 8.28857C3.83861 8.28857 3.98847 8.35239 4.11624 8.48003C4.24388 8.60767 4.3077 8.75753 4.3077 8.92961C4.3077 9.10156 4.24388 9.25135 4.11624 9.37899C3.98847 9.50663 3.83861 9.57045 3.66666 9.57045ZM6.99999 9.57045C6.82805 9.57045 6.67819 9.50663 6.55041 9.37899C6.42277 9.25135 6.35895 9.10156 6.35895 8.92961C6.35895 8.75753 6.42277 8.60767 6.55041 8.48003C6.67819 8.35239 6.82805 8.28857 6.99999 8.28857C7.17194 8.28857 7.3218 8.35239 7.44958 8.48003C7.57722 8.60767 7.64104 8.75753 7.64104 8.92961C7.64104 9.10156 7.57722 9.25135 7.44958 9.37899C7.3218 9.50663 7.17194 9.57045 6.99999 9.57045ZM10.3333 9.57045C10.1614 9.57045 10.0115 9.50663 9.88374 9.37899C9.75611 9.25135 9.69229 9.10156 9.69229 8.92961C9.69229 8.75753 9.75611 8.60767 9.88374 8.48003C10.0115 8.35239 10.1614 8.28857 10.3333 8.28857C10.5053 8.28857 10.6551 8.35239 10.7829 8.48003C10.9106 8.60767 10.9744 8.75753 10.9744 8.92961C10.9744 9.10156 10.9106 9.25135 10.7829 9.37899C10.6551 9.50663 10.5053 9.57045 10.3333 9.57045ZM1.67958 15.5C1.29597 15.5 0.975689 15.3716 0.718745 15.1146C0.4618 14.8577 0.333328 14.5374 0.333328 14.1538V3.51295C0.333328 3.12934 0.4618 2.80906 0.718745 2.55211C0.975689 2.29517 1.29597 2.1667 1.67958 2.1667H3.15374V0.307739H4.05124V2.1667H10.0129V0.307739H10.8462V2.1667H12.3204C12.704 2.1667 13.0243 2.29517 13.2812 2.55211C13.5382 2.80906 13.6667 3.12934 13.6667 3.51295V14.1538C13.6667 14.5374 13.5382 14.8577 13.2812 15.1146C13.0243 15.3716 12.704 15.5 12.3204 15.5H1.67958ZM1.67958 14.6667H12.3204C12.4487 14.6667 12.5663 14.6133 12.6731 14.5065C12.7799 14.3997 12.8333 14.2821 12.8333 14.1538V6.84628H1.16666V14.1538C1.16666 14.2821 1.22006 14.3997 1.32687 14.5065C1.43368 14.6133 1.55124 14.6667 1.67958 14.6667ZM1.16666 6.01274H12.8333V3.51295C12.8333 3.38461 12.7799 3.26704 12.6731 3.16024C12.5663 3.05343 12.4487 3.00003 12.3204 3.00003H1.67958C1.55124 3.00003 1.43368 3.05343 1.32687 3.16024C1.22006 3.26704 1.16666 3.38461 1.16666 3.51295V6.01274Z" fill="#511371"/>
                            </svg>
                            <input type="text" id="return-date" name="return_date" placeholder="<?php echo __('Optional', 'travel'); ?>" readonly>
                        </div>
                    </div>
                </div>
                <!-- END DATES -->

                <!-- PASSENGERS & SUBMIT -->
                <div class="passengers-submit">
                    <div class="form-field passengers-con">
                        <label for="passengers"><?php echo __( 'Passengers', 'travel')?></label>
                        <div class="passenger">
                            <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M4.19396 5.48706C3.93202 5.48706 3.71376 5.39039 3.53917 5.19706C3.36459 5.00373 3.29598 4.77456 3.33334 4.50956L3.58813 2.51602C3.66716 1.92727 3.93744 1.44192 4.39896 1.05998C4.86049 0.678033 5.39417 0.487061 6.00001 0.487061C6.60584 0.487061 7.13952 0.678033 7.60105 1.05998C8.06257 1.44192 8.33285 1.92727 8.41188 2.51602L8.66667 4.50956C8.70403 4.77456 8.63542 5.00373 8.46084 5.19706C8.28625 5.39039 8.06799 5.48706 7.80605 5.48706H4.19396ZM4.14584 4.65373H7.85417L7.58334 2.65373C7.52778 2.26484 7.3507 1.94539 7.05209 1.69539C6.75348 1.44539 6.40278 1.32039 6.00001 1.32039C5.59723 1.32039 5.24653 1.44539 4.94792 1.69539C4.64931 1.94539 4.47223 2.26484 4.41667 2.65373L4.14584 4.65373ZM0.166672 11.5129V10.141C0.166672 9.79699 0.266811 9.47512 0.467088 9.17539C0.667505 8.87581 0.937019 8.64317 1.27563 8.47748C2.06202 8.10039 2.84889 7.81755 3.63626 7.62894C4.42362 7.44046 5.21153 7.34623 6.00001 7.34623C6.78848 7.34623 7.57639 7.44046 8.36376 7.62894C9.15112 7.81755 9.93799 8.10039 10.7244 8.47748C11.063 8.64317 11.3325 8.87581 11.5329 9.17539C11.7332 9.47512 11.8333 9.79699 11.8333 10.141V11.5129H0.166672ZM1.00001 10.6796H11V10.141C11 9.95616 10.9404 9.78255 10.8213 9.62019C10.7022 9.45782 10.5374 9.32053 10.3269 9.20831C9.64105 8.87609 8.93389 8.62157 8.20542 8.44477C7.47695 8.26796 6.74181 8.17956 6.00001 8.17956C5.2582 8.17956 4.52306 8.26796 3.79459 8.44477C3.06612 8.62157 2.35896 8.87609 1.67313 9.20831C1.46257 9.32053 1.29778 9.45782 1.17876 9.62019C1.05959 9.78255 1.00001 9.95616 1.00001 10.141V10.6796Z" fill="#511371"/>
                            </svg>
                            <input type="number" id="passengers" name="passengers" value="1" min="1" max="9" required>
                        </div>
                    </div>
                
                    <div class="form-field">
                        <button type="submit" class="search-btn">
                            <span class="button-text"><?php echo __( 'Search', 'travel')?></span>
                            <span class="button-icon">
                                <svg width="19" height="20" viewBox="0 0 19 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M7.71387 0.516602C9.75362 0.516602 11.4869 1.22548 12.9043 2.64062C14.3216 4.05618 15.0312 5.78923 15.0312 7.83008C15.0312 8.71678 14.8747 9.5758 14.5605 10.4053C14.2654 11.1846 13.8799 11.8589 13.4072 12.4297L18.6641 18.0938L18.7627 18.2002L18.6602 18.3018L17.7764 19.1865L17.666 19.2969L17.5596 19.1826L12.3086 13.5254C11.6955 14.0252 10.9989 14.4168 10.2178 14.6973C9.38996 14.9944 8.55626 15.1436 7.71777 15.1436C5.67702 15.1435 3.9439 14.4352 2.52832 13.0205C1.11321 11.6059 0.404406 9.8743 0.404297 7.83496C0.404297 5.79507 1.11262 4.06105 2.52734 2.64355C3.94209 1.22626 5.67418 0.516647 7.71387 0.516602ZM7.71777 2.06738C6.09775 2.06746 4.73663 2.62352 3.62402 3.73633C2.51121 4.84894 1.95516 6.21005 1.95508 7.83008C1.95508 9.45026 2.51113 10.8121 3.62402 11.9248C4.73661 13.0375 6.09781 13.5937 7.71777 13.5938C9.33774 13.5938 10.6996 13.0377 11.8125 11.9248C12.9254 10.8121 13.4814 9.45026 13.4814 7.83008C13.4814 6.21012 12.9252 4.84891 11.8125 3.73633C10.6996 2.62342 9.33774 2.06738 7.71777 2.06738Z" fill="white" stroke="white" stroke-width="0.3"/>
                                </svg>
                            </span>
                    </button>
                    </div>
                </div>
                <!-- END PASSENGERS & SUBMIT -->

            </div>
        </form>
    </div>
    <?php
    return ob_get_clean();
}
add_shortcode('bus_search_form', 'bus_search_form_shortcode');

// WP-Cron za refresh cache
add_action('wp', 'schedule_cities_cache_refresh');
function schedule_cities_cache_refresh() {
    if (!wp_next_scheduled('refresh_bus_cities_cache')) {
        wp_schedule_event(time(), 'daily', 'refresh_bus_cities_cache');
    }
}

add_action('refresh_bus_cities_cache', 'refresh_cities_cache');
function refresh_cities_cache() {
    $langs = array('MNE', 'EN', 'RU');
    foreach ($langs as $lang) {
        delete_transient('bus_cities_' . $lang . '_v3');
        // Trigger cache rebuild
        wp_remote_get(rest_url('busticket/v1/cities/' . $lang));
    }
}

// Manual cache clear (/wp-admin/?clear_bus_cache=1)
add_action('admin_init', function() {
    if (isset($_GET['clear_bus_cache']) && current_user_can('manage_options')) {
        delete_transient('bus_cities_MNE_v3');
        delete_transient('bus_cities_EN_v3');
        delete_transient('bus_cities_RU_v3');
        wp_die('✅ Bus cities cache cleared! <br><br><a href="' . admin_url() . '">← Back to Dashboard</a>');
    }
});